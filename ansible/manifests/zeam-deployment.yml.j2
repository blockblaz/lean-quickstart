apiVersion: apps/v1
kind: Deployment
metadata:
  name: {{ node_name | replace('_', '-') }}
  namespace: {{ k8s_namespace }}
  labels:
    app: {{ node_name | replace('_', '-') }}
    managed-by: ansible
spec:
  replicas: 1
  selector:
    matchLabels:
      app: {{ node_name | replace('_', '-') }}
  template:
    metadata:
      labels:
        app: {{ node_name | replace('_', '-') }}
    spec:
      containers:
      - name: zeam
        image: {{ zeam_docker_image }}
        imagePullPolicy: IfNotPresent
        securityContext:
          capabilities:
            add:
              - SYS_ADMIN
          seccompProfile:
            type: Unconfined
        args:
          - node
          - --custom_genesis /config
          - --validator_config {{ validator_config | default('genesis_bootnode') }}
          - --data-dir /data
          - --node-id {{ node_name }}
          - --node-key /config/{{ node_name }}.key
          - --metrics_port {{ metrics_port }}
        ports:
        - name: metrics
          containerPort: {{ metrics_port }}
        - name: quic
          containerPort: {{ quic_port }}
        volumeMounts:
        - name: config
          mountPath: /config
          readOnly: true
        - name: data
          mountPath: /data
        resources:
          requests:
            cpu: {{ k8s_cpu_request }}
            memory: {{ k8s_memory_request }}
          limits:
            cpu: {{ k8s_cpu_limit }}
            memory: {{ k8s_memory_limit }}
      volumes:
      - name: config
        hostPath:
          path: {{ genesis_dir }}
          type: Directory
      - name: data
        persistentVolumeClaim:
          claimName: {{ node_name | replace('_', '-') }}-data
---
apiVersion: v1
kind: Service
metadata:
  name: {{ node_name | replace('_', '-') }}-metrics
  namespace: {{ k8s_namespace }}
  labels:
    app: {{ node_name | replace('_', '-') }}
    managed-by: ansible
spec:
  type: NodePort
  selector:
    app: {{ node_name | replace('_', '-') }}
  ports:
  - name: metrics
    port: {{ metrics_port }}
    targetPort: metrics
---
apiVersion: v1
kind: Service
metadata:
  name: {{ node_name | replace('_', '-') }}-quic
  namespace: {{ k8s_namespace }}
  labels:
    app: {{ node_name | replace('_', '-') }}
    managed-by: ansible
spec:
  type: ClusterIP
  selector:
    app: {{ node_name | replace('_', '-') }}
  ports:
  - name: quic
    port: {{ quic_port }}
    targetPort: quic

