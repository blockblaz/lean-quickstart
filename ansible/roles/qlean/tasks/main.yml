---
# Qlean role: Deploy and manage Qlean nodes
# Converts client-cmds/qlean-cmd.sh logic to Ansible tasks
# Note: deploy-validator-config.yaml has user overrides merged (from merge-config.sh)

- name: Extract node configuration from deploy-validator-config.yaml
  shell: |
    yq eval ".validators[] | select(.name == \"{{ node_name }}\") | .{{ item }}" "{{ genesis_dir }}/deploy-validator-config.yaml"
  register: qlean_node_config
  changed_when: false
  loop:
    - image
    - enrFields.quic
    - metricsPort
  when: node_name is defined

- name: Set node configuration
  set_fact:
    qlean_docker_image: "{{ qlean_node_config.results[0].stdout | trim | default('qdrvm/qlean-mini:latest') }}"
    qlean_quic_port: "{{ qlean_node_config.results[1].stdout | trim }}"
    qlean_metrics_port: "{{ qlean_node_config.results[2].stdout | trim }}"
    deployment_mode: "{{ deployment_mode | default('docker') }}"
  when: qlean_node_config is defined

- name: Extract validator index from validators.yaml
  shell: |
    yq eval '."{{ node_name }}" | .[0]' "{{ genesis_dir }}/validators.yaml"
  register: qlean_validator_index_raw
  changed_when: false
  failed_when: false

- name: Set validator index
  set_fact:
    qlean_validator_index: "{{ qlean_validator_index_raw.stdout | trim | default('0') }}"
  when: qlean_validator_index_raw is defined

- name: Ensure node key file exists
  stat:
    path: "{{ genesis_dir }}/{{ node_name }}.key"
  register: node_key_stat

- name: Debug node key file check
  debug:
    msg: "Checking for key file at {{ genesis_dir }}/{{ node_name }}.key - exists: {{ node_key_stat.stat.exists | default('undefined') }}"

- name: Fail if node key file is missing
  fail:
    msg: "Node key file {{ node_name }}.key not found in {{ genesis_dir }}"
  when: not (node_key_stat.stat.exists | default(false))

- name: Create node data directory
  file:
    path: "{{ data_dir }}/{{ node_name }}"
    state: directory
    mode: '0755'

- name: Deploy Qlean node using Docker
  block:
    - name: Stop existing Qlean container (if any)
      command: docker rm -f {{ node_name }}
      register: qlean_stop
      failed_when: false
      changed_when: qlean_stop.rc == 0

    - name: Start Qlean container
      command: >-
        docker run -d
        --pull=always
        --name {{ node_name }}
        --restart unless-stopped
        --network host
        --platform {{ qlean_docker_platform }}
        {{ '--init --ulimit core=-1 --workdir /data' if (enable_core_dumps | default('') == 'all') or (node_name in (enable_core_dumps | default('')).split(',')) or (node_name.split('_')[0] in (enable_core_dumps | default('')).split(',')) else '' }}
        -v {{ genesis_dir }}:/config:ro
        -v {{ data_dir }}/{{ node_name }}:/data
        {{ qlean_docker_image }}
        --genesis /config/config.yaml
        --validator-registry-path /config/validators.yaml
        --validator-keys-manifest /config/hash-sig-keys/validator-keys-manifest.yaml
        --xmss-pk /config/hash-sig-keys/validator_{{ qlean_validator_index }}_pk.json
        --xmss-sk /config/hash-sig-keys/validator_{{ qlean_validator_index }}_sk.json
        --bootnodes /config/nodes.yaml
        --data-dir /data
        --node-id {{ node_name }}
        --node-key /config/{{ node_name }}.key
        --listen-addr /ip4/0.0.0.0/udp/{{ qlean_quic_port }}/quic-v1
        --prometheus-port {{ qlean_metrics_port }}
        -ldebug
      register: qlean_container
      changed_when: qlean_container.rc == 0
  when: deployment_mode == 'docker'
