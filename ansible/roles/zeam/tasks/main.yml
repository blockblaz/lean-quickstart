---
# Zeam role: Deploy and manage Zeam nodes
# Converts client-cmds/zeam-cmd.sh logic to Ansible tasks

- name: Extract node configuration from validator-config.yaml
  shell: |
    yq eval ".validators[] | select(.name == \"{{ node_name }}\") | .{{ item }}" "{{ genesis_dir }}/validator-config.yaml"
  register: node_config
  changed_when: false
  loop:
    - metricsPort
    - privkey
  when: node_name is defined

- name: Set node metrics port
  set_fact:
    zeam_metrics_port: "{{ node_config.results[0].stdout }}"
  when: node_config is defined

- name: Ensure node key file exists
  stat:
    path: "{{ genesis_dir }}/{{ node_name }}.key"
  register: node_key_stat

- name: Fail if node key file is missing
  fail:
    msg: "Node key file {{ node_name }}.key not found in {{ genesis_dir }}"
  when: not node_key_stat.stat.exists

- name: Clean node data directory
  file:
    path: "{{ data_dir }}/{{ node_name }}"
    state: absent
  when: clean_data | default(false)

- name: Create node data directory
  file:
    path: "{{ data_dir }}/{{ node_name }}"
    state: directory
    mode: '0755'

- name: Set validator config value
  set_fact:
    actual_validator_config: "{{ validator_config if validator_config is defined and validator_config != '' else 'genesis_bootnode' }}"

- name: Deploy Zeam node using Docker
  block:
    - name: Pull Zeam docker image
      command: docker pull {{ zeam_docker_image }}
      register: docker_pull_result
      changed_when: '"Downloaded newer image" in docker_pull_result.stdout'

    - name: Stop existing Zeam container (if any)
      command: docker rm -f {{ node_name }}
      register: docker_stop_result
      failed_when: false
      changed_when: docker_stop_result.rc == 0

    - name: Start Zeam container
      command: >-
        docker run -d
        --name {{ node_name }}
        --restart unless-stopped
        --network host
        --security-opt seccomp=unconfined
        -v {{ genesis_dir }}:/config:ro
        -v {{ data_dir }}/{{ node_name }}:/data
        {{ zeam_docker_image }}
        node
        --custom_genesis /config
        --validator_config {{ actual_validator_config }}
        --data-dir /data
        --node-id {{ node_name }}
        --node-key /config/{{ node_name }}.key
        --metrics_port {{ zeam_metrics_port }}
      register: zeam_container_result
      changed_when: zeam_container_result.rc == 0

- name: Deploy Zeam node using binary
  block:
    - name: Check if binary exists
      stat:
        path: "{{ zeam_binary_path }}"
      register: binary_stat

    - name: Fail if binary not found
      fail:
        msg: "Zeam binary not found at {{ zeam_binary_path }}"
      when: not binary_stat.stat.exists

    - name: Create systemd service for Zeam
      template:
        src: zeam.service.j2
        dest: "/etc/systemd/system/zeam-{{ node_name }}.service"
        mode: '0644'
      become: yes
      when: ansible_connection != 'local'

    - name: Start and enable Zeam service
      systemd:
        name: "zeam-{{ node_name }}"
        state: started
        enabled: yes
        daemon_reload: yes
      become: yes
      when: ansible_connection != 'local'
  when: deployment_mode == 'binary'

- name: Deploy Zeam node using Kubernetes
  block:
    - name: Set default QUIC port
      set_fact:
        quic_port: "{{ node_config.results[1].stdout if node_config.results|length > 1 else '9000' }}"
      when: quic_port is not defined

    - name: Extract QUIC port from config
      shell: |
        yq eval ".validators[] | select(.name == \"{{ node_name }}\") | .enrFields.quic" "{{ genesis_dir }}/validator-config.yaml"
      register: quic_port_config
      changed_when: false
      failed_when: false

    - name: Set QUIC port from config
      set_fact:
        quic_port: "{{ quic_port_config.stdout }}"
      when: quic_port_config.stdout is defined and quic_port_config.stdout != ""

    - name: Ensure kubectl is available
      command: kubectl version --client
      register: kubectl_check
      changed_when: false
      failed_when: false

    - name: Fail if kubectl not found
      fail:
        msg: "kubectl is required for Kubernetes deployment mode"
      when: kubectl_check.rc != 0

    - name: Create Kubernetes namespace
      kubernetes.core.k8s:
        state: present
        definition:
          apiVersion: v1
          kind: Namespace
          metadata:
            name: "{{ k8s_namespace }}"
            labels:
              app: lean-network
              managed-by: ansible

    - name: Set sanitized PVC name
      set_fact:
        pvc_name: "{{ node_name | replace('_', '-') }}-data"

    - name: Create PersistentVolumeClaim for node data
      kubernetes.core.k8s:
        state: present
        definition:
          apiVersion: v1
          kind: PersistentVolumeClaim
          metadata:
            name: "{{ pvc_name }}"
            namespace: "{{ k8s_namespace }}"
            labels:
              app: "{{ node_name }}"
              managed-by: ansible
          spec:
            accessModes:
              - ReadWriteOnce
            storageClassName: "{{ k8s_storage_class }}"
            resources:
              requests:
                storage: "{{ k8s_storage_size }}"

    - name: Check PVC binding mode
      kubernetes.core.k8s_info:
        kind: StorageClass
        name: "{{ k8s_storage_class }}"
      register: storageclass_info

    - name: Wait for PVC to be bound
      kubernetes.core.k8s_info:
        kind: PersistentVolumeClaim
        name: "{{ pvc_name }}"
        namespace: "{{ k8s_namespace }}"
        wait: yes
        wait_condition:
          type: Bound
          status: "True"
      when: >
        storageclass_info['resources'] | length > 0 and
        storageclass_info['resources'][0].volumeBindingMode != 'WaitForFirstConsumer'

    - name: Render Kubernetes deployment manifest
      template:
        src: ../manifests/zeam-deployment.yml.j2
        dest: /tmp/{{ node_name }}-deployment.yml
      vars:
        metrics_port: "{{ zeam_metrics_port }}"
        quic_port: "{{ quic_port }}"
        validator_config: "{{ actual_validator_config }}"

    - name: Create Kubernetes deployment and services
      shell: kubectl apply -f /tmp/{{ node_name }}-deployment.yml
      register: apply_result
    - name: Display kubectl apply output
      debug:
        var: apply_result.stdout_lines

    - name: Clean up temporary manifest file
      file:
        path: /tmp/{{ node_name }}-deployment.yml
        state: absent

    - name: Display deployment status
      shell: kubectl get deploy,pods,svc -n {{ k8s_namespace }}
      register: k8s_status
      changed_when: false
      
    - name: Show deployment status
      debug:
        var: k8s_status.stdout_lines
        
  when: deployment_mode == 'kubernetes'

