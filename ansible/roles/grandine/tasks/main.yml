---
# Grandine role: Deploy and manage Grandine nodes
# Converts client-cmds/grandine-cmd.sh logic to Ansible tasks

- name: Extract docker image from config file
  shell: |
    # Read image from user config file if provided, otherwise from validator-config.yaml
    validator_config="{{ genesis_dir }}/validator-config.yaml"
    user_config="{{ user_config_file | default('') }}"

    # Try user config first if provided (supports both 'nodes' and 'clients' format)
    if [ -n "$user_config" ] && [ -f "$user_config" ]; then
      # Try nodes format first (grandine_0 style)
      image=$(yq eval '.nodes[] | select(.name | test("^grandine_")) | .image' "$user_config" 2>/dev/null | head -1)
      if [ -n "$image" ] && [ "$image" != "null" ]; then
        echo "$image"
        exit 0
      fi
      # Try clients format (backwards compatibility)
      image=$(yq eval '.clients[] | select(.name == "grandine") | .image' "$user_config" 2>/dev/null)
      if [ -n "$image" ] && [ "$image" != "null" ]; then
        echo "$image"
        exit 0
      fi
    fi

    # Fall back to validator-config.yaml (read from validators array)
    yq eval '.validators[] | select(.name | test("^grandine_")) | .image' "$validator_config" | head -1
  register: grandine_docker_image_raw
  changed_when: false
  delegate_to: localhost
  run_once: true

- name: Extract deployment mode from client-cmd.sh
  shell: |
    # Extract the value from node_setup line
    # playbook_dir points to ansible/playbooks, go up two levels to reach project root
    project_root="$(cd '{{ playbook_dir }}/../..' && pwd)"
    grep -E '^node_setup=' "$project_root/client-cmds/grandine-cmd.sh" | head -1 | sed -E 's/.*node_setup="([^"]+)".*/\1/'
  register: grandine_deployment_mode_raw
  changed_when: false
  delegate_to: localhost
  run_once: true

- name: Set docker image and deployment mode from client-cmd.sh
  set_fact:
    grandine_docker_image: "{{ grandine_docker_image_raw.stdout | trim | default('sifrai/lean:unstable') }}"
    deployment_mode: "{{ grandine_deployment_mode_raw.stdout | trim | default('docker') }}"

- name: Extract node configuration from validator-config.yaml
  shell: |
    yq eval ".validators[] | select(.name == \"{{ node_name }}\") | .{{ item }}" "{{ genesis_dir }}/validator-config.yaml"
  register: grandine_node_config
  changed_when: false
  loop:
    - enrFields.quic
    - privkey
  when: node_name is defined

- name: Set node ports
  set_fact:
    grandine_quic_port: "{{ grandine_node_config.results[0].stdout }}"
    grandine_privkey: "{{ grandine_node_config.results[1].stdout }}"
  when: grandine_node_config is defined

- name: Ensure node key file exists
  stat:
    path: "{{ genesis_dir }}/{{ node_name }}.key"
  register: node_key_stat

- name: Debug node key file check
  debug:
    msg: "Checking for key file at {{ genesis_dir }}/{{ node_name }}.key - exists: {{ node_key_stat.stat.exists | default('undefined') }}"

- name: Fail if node key file is missing
  fail:
    msg: "Node key file {{ node_name }}.key not found in {{ genesis_dir }}"
  when: not (node_key_stat.stat.exists | default(false))

- name: Clean node data directory
  file:
    path: "{{ data_dir }}/{{ node_name }}"
    state: absent
  when: clean_data | default(false) | bool

- name: Create node data directory
  file:
    path: "{{ data_dir }}/{{ node_name }}"
    state: directory
    mode: '0755'

- name: Deploy Grandine node using Docker
  block:
    - name: Stop existing Grandine container (if any)
      command: docker rm -f {{ node_name }}
      register: grandine_stop
      failed_when: false
      changed_when: grandine_stop.rc == 0

    - name: Start Grandine container
      command: >-
        docker run -d
        --pull=always
        --name {{ node_name }}
        --restart unless-stopped
        --network host
        -v {{ genesis_dir }}:/config:ro
        -v {{ data_dir }}/{{ node_name }}:/data
        {{ grandine_docker_image }}
        --genesis /config/config.yaml
        --validator-registry-path /config/validators.yaml
        --bootnodes /config/nodes.yaml
        --node-id {{ node_name }}
        --node-key /config/{{ node_name }}.key
        --port {{ grandine_quic_port }}
        --address 0.0.0.0
        --hash-sig-key-dir /config/hash-sig-keys
      register: grandine_container
      changed_when: grandine_container.rc == 0
  when: deployment_mode == 'docker'
