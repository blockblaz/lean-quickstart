---
# Genesis playbook: Generate genesis files
# Equivalent to running generate-genesis.sh

- name: Generate Genesis Files
  hosts: localhost
  connection: local
  gather_facts: yes
  vars:
    validator_config_file: "{{ genesis_dir }}/validator-config.yaml"

  tasks:
    - name: Include common role for dependency checks
      include_role:
        name: common
      tags:
        - genesis
        - setup

    - name: Include genesis role
      include_role:
        name: genesis
      tags:
        - genesis

    - name: Extract node names for later use
      shell: |
        yq eval '.validators[].name' {{ validator_config_file }}
      register: extracted_node_names
      changed_when: false
      tags:
        - genesis

    - name: Set node names fact
      set_fact:
        node_names: "{{ extracted_node_names.stdout_lines }}"
      tags:
        - genesis

    - name: Display generated files summary
      debug:
        msg: |
          âœ… Genesis generation complete!
          
          Generated files:
            - {{ genesis_dir }}/config.yaml
            - {{ genesis_dir }}/validators.yaml
            - {{ genesis_dir }}/nodes.yaml
            - {{ genesis_dir }}/genesis.json
            - {{ genesis_dir }}/genesis.ssz
            - {{ genesis_dir }}/*.key (private key files)
          
          Nodes: {{ node_names | join(', ') }}
      tags:
        - genesis

